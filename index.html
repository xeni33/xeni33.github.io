<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Charge Calculator</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
  input, button { padding: 8px; margin: 5px 0; width: 100%; }
  label { font-weight: bold; display: block; margin-top: 10px; }
  .output { margin-top: 20px; padding: 10px; background: #fff; border-radius: 5px; }
</style>
</head>
<body>
<h2>Charge Calculator</h2>

<label>Charge duration (hours:minutes)</label>
<input type="text" id="chargeDuration" placeholder="e.g. 1:00">

<label>Emptying duration (hours:minutes)</label>
<input type="text" id="emptyDuration" placeholder="e.g. 1:00">

<label>Last known charge time (HH:MM)</label>
<input type="text" id="lastTime" placeholder="e.g. 07:50">

<label>Last charge number</label>
<input type="number" id="lastNumber" placeholder="e.g. 28">

<label>Target empty date and time</label>
<input type="datetime-local" id="targetDateTime">

<button onclick="calculateCharges()">Calculate</button>

<div class="output" id="output"></div>

<script>
function parseTimeHM(str) {
  let [h,m] = str.split(":").map(Number);
  return h*60 + m;
}

function addMinutes(date, minutes) {
  return new Date(date.getTime() + minutes*60000);
}

function formatDateTime(date) {
  return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}

function calculateCharges() {
  const chargeDur = parseTimeHM(document.getElementById("chargeDuration").value);
  const emptyDur = parseTimeHM(document.getElementById("emptyDuration").value);
  const lastTimeStr = document.getElementById("lastTime").value;
  const lastNum = parseInt(document.getElementById("lastNumber").value);
  const targetDateTimeStr = document.getElementById("targetDateTime").value;

  if (!chargeDur || !emptyDur || !lastTimeStr || isNaN(lastNum) || !targetDateTimeStr) {
    document.getElementById("output").innerHTML = "Please fill all fields correctly.";
    return;
  }

  // Parse target datetime
  const targetDateTime = new Date(targetDateTimeStr);

  // Parse last known charge HH:MM and convert to datetime close to target
  const [lastH,lastM] = lastTimeStr.split(":").map(Number);
  let lastChargeDate = new Date(targetDateTime);
  lastChargeDate.setHours(lastH);
  lastChargeDate.setMinutes(lastM);
  lastChargeDate.setSeconds(0);
  lastChargeDate.setMilliseconds(0);

  // If last charge datetime is after lastChargeStart, go back one day
  const lastChargeStart = new Date(targetDateTime.getTime() - (chargeDur + emptyDur)*60000);
  if (lastChargeDate > lastChargeStart) {
    lastChargeDate.setDate(lastChargeDate.getDate() - 1);
  }

  // Total minutes between last known charge and last charge start
  const totalMinutes = (lastChargeStart - lastChargeDate)/60000;

  // Number of full charges (500 kg) before last charge
  let fullChargesNeeded = Math.floor(totalMinutes / chargeDur);
  if (fullChargesNeeded < 0) fullChargesNeeded = 0;

  // Build schedule for full charges
  const schedule = [];
  for (let i=1; i<=fullChargesNeeded; i++){
    const chargeTime = addMinutes(lastChargeDate, i*chargeDur);
    schedule.push(`Charge ${lastNum + i}: ${formatDateTime(chargeTime)} - 500 kg`);
  }

  // Last charge kg
  let lastChargeKg = 500; // default
  const remainingMinutes = totalMinutes - fullChargesNeeded*chargeDur;
  if (remainingMinutes > 0) {
    lastChargeKg = Math.round((remainingMinutes / chargeDur) * 500);
    if (lastChargeKg < 200) lastChargeKg = 200;
    if (lastChargeKg > 500) lastChargeKg = 500;
  }

  // Add last charge
  schedule.push(`Last charge ${lastNum + fullChargesNeeded + 1}: ${formatDateTime(lastChargeStart)} - ${lastChargeKg} kg`);

  // Output
  document.getElementById("output").innerHTML = `
    Total additional charges needed: <b>${fullChargesNeeded + 1}</b><br>
    Schedule:<br>${schedule.join('<br>')}<br>
    Line completely empty at: <b>${formatDateTime(targetDateTime)}</b>
  `;
}
</script>
</body>
</html>
