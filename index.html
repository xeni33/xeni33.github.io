<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Charge Calculator</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
  input, button { padding: 8px; margin: 5px 0; width: 100%; }
  label { font-weight: bold; display: block; margin-top: 10px; }
  .output { margin-top: 20px; padding: 10px; background: #fff; border-radius: 5px; }
</style>
</head>
<body>
<h2>Charge Calculator</h2>

<label>Charge duration (hours:minutes)</label>
<input type="text" id="chargeDuration" placeholder="e.g. 1:50">

<label>Emptying duration (hours:minutes)</label>
<input type="text" id="emptyDuration" placeholder="e.g. 2:30">

<label>Full charge amount (kg)</label>
<input type="number" id="fullChargeAmount" placeholder="e.g. 400">

<label>Last known charge time (HH:MM)</label>
<input type="text" id="lastTime" placeholder="e.g. 07:50">

<label>Last charge number</label>
<input type="number" id="lastNumber" placeholder="e.g. 28">

<label>Target empty date and time</label>
<input type="datetime-local" id="targetDateTime">

<button onclick="calculateCharges()">Calculate</button>

<div class="output" id="output"></div>

<script>
function parseTimeHM(str) {
  let [h,m] = str.split(":").map(Number);
  return h*60 + m;
}

function addMinutes(date, minutes) {
  return new Date(date.getTime() + minutes*60000);
}

function formatDateTime(date) {
  return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}

function calculateCharges() {
  let chargeDur = parseTimeHM(document.getElementById("chargeDuration").value);
  let emptyDur = parseTimeHM(document.getElementById("emptyDuration").value);
  let fullCharge = parseFloat(document.getElementById("fullChargeAmount").value);
  let lastTimeStr = document.getElementById("lastTime").value;
  let lastNum = parseInt(document.getElementById("lastNumber").value);
  let targetDateTimeStr = document.getElementById("targetDateTime").value;

  if (!chargeDur || !emptyDur || !fullCharge || !lastTimeStr || isNaN(lastNum) || !targetDateTimeStr) {
    document.getElementById("output").innerHTML = "Please fill all fields correctly.";
    return;
  }

  // Parse last known charge time
  let today = new Date();
  let [lastH,lastM] = lastTimeStr.split(":").map(Number);
  let lastChargeDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), lastH, lastM);

  // Parse target date/time
  let targetDateTime = new Date(targetDateTimeStr);

  // Last charge start time
  let lastChargeStart = new Date(targetDateTime.getTime() - (chargeDur + emptyDur)*60000);

  // Total time in minutes between last known charge and last charge start
  let totalMinutes = (lastChargeStart - lastChargeDate)/60000;

  // Number of full charges before last
  let fullChargesNeeded = Math.floor(totalMinutes / chargeDur);

  // Fraction for last charge
  let remainingFraction = (totalMinutes / chargeDur) - fullChargesNeeded;
  let lastChargeKg = remainingFraction * fullCharge;

  // Build full schedule
  let schedule = [];
  for (let i=1; i<=fullChargesNeeded; i++){
    let chargeTime = addMinutes(lastChargeDate, i*chargeDur);
    schedule.push(`Charge ${lastNum + i}: ${formatDateTime(chargeTime)} - ${fullCharge} kg`);
  }

  // Add last charge
  schedule.push(`Last charge ${lastNum + fullChargesNeeded + 1}: ${formatDateTime(lastChargeStart)} - ${lastChargeKg.toFixed(1)} kg`);

  document.getElementById("output").innerHTML = `
    Total additional charges needed: <b>${fullChargesNeeded + 1}</b><br>
    Schedule:<br>${schedule.join('<br>')}<br>
    Line completely empty at: <b>${formatDateTime(targetDateTime)}</b>
  `;
}
</script>
</body>
</html>
