<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Charge Calculator</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
  input, button { padding: 8px; margin: 5px 0; width: 100%; }
  label { font-weight: bold; display: block; margin-top: 10px; }
  .output { margin-top: 20px; padding: 10px; background: #fff; border-radius: 5px; }
</style>
</head>
<body>
<h2>Charge Calculator</h2>

<label>Charge duration (hours:minutes)</label>
<input type="text" id="chargeDuration" placeholder="e.g. 1:50">

<label>Emptying duration (hours:minutes)</label>
<input type="text" id="emptyDuration" placeholder="e.g. 2:30">

<label>Last known charge time (HH:MM)</label>
<input type="text" id="lastTime" placeholder="e.g. 07:50">

<label>Last charge number</label>
<input type="number" id="lastNumber" placeholder="e.g. 28">

<label>Target empty date and time</label>
<input type="datetime-local" id="targetDateTime">

<button onclick="calculateCharges()">Calculate</button>

<div class="output" id="output"></div>

<script>
function parseTimeHM(str) {
  let [h,m] = str.split(":").map(Number);
  return h*60 + m;
}

function formatDayTime(minutesFromStart, startDate) {
  let date = new Date(startDate.getTime() + minutesFromStart*60000);
  let day = date.toLocaleDateString();
  let time = date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  return `${day} ${time}`;
}

function calculateCharges() {
  let chargeDur = parseTimeHM(document.getElementById("chargeDuration").value);
  let emptyDur = parseTimeHM(document.getElementById("emptyDuration").value);
  let lastTimeStr = document.getElementById("lastTime").value;
  let lastNum = parseInt(document.getElementById("lastNumber").value);
  let targetDateTimeStr = document.getElementById("targetDateTime").value;

  if (!chargeDur || !emptyDur || !lastTimeStr || isNaN(lastNum) || !targetDateTimeStr) {
    document.getElementById("output").innerHTML = "Please fill all fields correctly.";
    return;
  }

  // Parse last known charge time as today
  let today = new Date();
  let [lastH,lastM] = lastTimeStr.split(":").map(Number);
  let lastChargeDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), lastH, lastM);

  // Parse target date/time
  let targetDateTime = new Date(targetDateTimeStr);

  // Total time for last charge to empty
  let totalLastChargeTime = chargeDur + emptyDur;

  // Last charge start time
  let lastChargeStart = new Date(targetDateTime.getTime() - totalLastChargeTime*60000);

  // Calculate number of full charges from last known charge
  let diffMinutes = (lastChargeStart - lastChargeDate) / 60000;
  let chargesNeeded = Math.ceil(diffMinutes / chargeDur);

  // Build schedule
  let schedule = [];
  for (let i=1; i<=chargesNeeded; i++){
    let time = new Date(lastChargeDate.getTime() + i*chargeDur*60000);
    schedule.push(`Charge ${lastNum + i}: ${formatDayTime(i*chargeDur, lastChargeDate)}`);
  }

  // Calculate last charge amount (assume all charges same, last may be smaller)
  let totalMinutes = (targetDateTime - lastChargeDate)/60000;
  let fullChargeCount = Math.floor(totalMinutes / chargeDur);
  let lastChargeAmount = totalMinutes - fullChargeCount*chargeDur;

  document.getElementById("output").innerHTML = `
    Last charge should start at: <b>${formatDayTime(totalMinutes - emptyDur, lastChargeDate)}</b><br>
    Total additional charges needed: <b>${chargesNeeded}</b><br>
    Schedule:<br>${schedule.join('<br>')}<br>
    Last charge amount: <b>${lastChargeAmount.toFixed(1)} minutes worth</b><br>
    Line completely empty at: <b>${targetDateTime.toLocaleString()}</b>
  `;
}
</script>
</body>
</html>
